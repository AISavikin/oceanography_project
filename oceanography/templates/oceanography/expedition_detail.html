{% extends 'base.html' %}
{% load humanize %}

{% block title %}{{ expedition.platform }} - –°–∏—Å—Ç–µ–º–∞ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π{% endblock %}

{% block extra_head %}
<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Leaflet –¥–ª—è –∫–∞—Ä—Ç -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Leaflet MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–∞—Ä—Ç—ã */
    #expedition-map {
        height: 500px;
        width: 100%;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        z-index: 1;
    }

    /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã */
    .custom-marker {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        background-color: #2a9d8f;
    }

    .custom-marker.with-samples {
        background-color: #e76f51;
    }

    .custom-marker.with-ctd {
        background-color: #f4a261;
    }

    /* –ü–æ–¥–ø–∏—Å–∏ —Å—Ç–∞–Ω—Ü–∏–π */
    .station-label {
        background-color: rgba(255, 255, 255, 0.95);
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        color: #2b2d42;
        border: 1px solid rgba(42, 157, 143, 0.3);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        white-space: nowrap;
        pointer-events: none;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        #expedition-map {
            height: 400px;
        }
    }
</style>
{% endblock %}

{% block content %}
    {% include 'include/_breadcrumbs.html' %}

    <div class="card mb-4">
        <div class="card-header">
            <h2 class="card-title mb-0">{{ expedition.platform }}</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</th>
                            <td>{{ expedition.start_date|date:"d.m.Y" }}</td>
                        </tr>
                        <tr>
                            <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</th>
                            <td>{{ expedition.end_date|date:"d.m.Y" }}</td>
                        </tr>
                        <tr>
                            <th>–†–∞–π–æ–Ω —Ä–∞–±–æ—Ç:</th>
                            <td>{{ expedition.area }}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–Ω—Ü–∏–π:</th>
                            <td>
                                <span class="badge bg-primary">{{ stations.count|intcomma }}</span>
                            </td>
                        </tr>
                        <tr>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–±:</th>
                            <td>
                                <span class="badge bg-success">{{ samples_count|intcomma }}</span>
                            </td>
                        </tr>
                        <tr>
                            <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</th>
                            <td>
                                {% if duration_days %}
                                    {{ duration_days }} –¥–Ω–µ–π
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- –ö–∞—Ä—Ç–∞ —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏ -->
    {% if stations %}
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">–ö–∞—Ä—Ç–∞ —Å—Ç–∞–Ω—Ü–∏–π —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏</h3>
            <small class="text-muted">–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ {{ stations.count }} —Å—Ç–∞–Ω—Ü–∏–π —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏</small>
        </div>
        <div class="card-body p-0">
            <div id="expedition-map"></div>
        </div>
    </div>
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏—è–º–∏</h3>
        <div class="btn-group">
            <a href="{% url 'oceanography:add_station_single' expedition.pk %}" class="btn btn-success">
                <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω—É —Å—Ç–∞–Ω—Ü–∏—é
            </a>
            <a href="{% url 'oceanography:add_stations_excel' expedition.pk %}" class="btn btn-outline-success">
                <i class="fas fa-layer-group"></i> –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
            </a>
        </div>
    </div>

    <!-- –ë–ª–æ–∫ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö -->
    <div class="card mb-4">
        <div class="card-header">
            <h3 class="card-title mb-0">–î–æ–±–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</h3>
        </div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-md-3 col-sm-6">
                    <a href="{% url 'oceanography:add_meteo_excel' expedition.pk %}" class="btn btn-outline-primary w-100">
                        üìä –ú–µ—Ç–µ–æ–¥–∞–Ω–Ω—ã–µ
                    </a>
                </div>
                <div class="col-md-3 col-sm-6">
                    <a href="{% url 'oceanography:coming_soon' %}" class="btn btn-outline-primary w-100">
                        üåø –î–∞–Ω–Ω—ã–µ –ø–æ —É–≥–ª–µ—Ä–æ–¥—É
                    </a>
                </div>
                <div class="col-md-3 col-sm-6">
                    <a href="{% url 'oceanography:coming_soon' %}" class="btn btn-outline-primary w-100">
                        ‚öóÔ∏è –ò–æ–Ω–Ω—ã–π —Å–æ—Å—Ç–∞–≤
                    </a>
                </div>
                <div class="col-md-3 col-sm-6">
                    <a href="{% url 'oceanography:coming_soon' %}" class="btn btn-outline-primary w-100">
                        üé® –ü–∏–≥–º–µ–Ω—Ç—ã
                    </a>
                </div>
                <div class="col-md-3 col-sm-6">
                    <a href="{% url 'oceanography:coming_soon' %}" class="btn btn-outline-primary w-100">
                        üíß –î–∞–Ω–Ω—ã–µ –æ–∫—Å–∏–º–µ—Ç—Ä–∞
                    </a>
                </div>
                <div class="col-md-3 col-sm-6">
                    <a href="{% url 'oceanography:coming_soon' %}" class="btn btn-outline-primary w-100">
                        üß™ –ë–∏–æ–≥–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                    </a>
                </div>
                <div class="col-md-3 col-sm-6">
                    <a href="{% url 'oceanography:coming_soon' %}" class="btn btn-outline-primary w-100">
                        üß¨ –ò–∑–º–µ—Ä–µ–Ω–∏—è pH
                    </a>
                </div>
                <div class="col-md-3 col-sm-6">
                    <a href="{% url 'oceanography:coming_soon' %}" class="btn btn-outline-primary w-100">
                        üì° –î–∞–Ω–Ω—ã–µ CTD
                    </a>
                </div>
                <div class="col-md-3 col-sm-6">
                    <a href="{% url 'oceanography:coming_soon' %}" class="btn btn-outline-primary w-100">
                        üîç –ó–æ–Ω–¥—ã
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title mb-0">–°—Ç–∞–Ω—Ü–∏–∏ —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏</h3>
        </div>
        <div class="card-body">
            {% if stations %}
            <div class="table-responsive">
                <table class="table table-striped table-hover data-table">
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏</th>
                            <th>–®–∏—Ä–æ—Ç–∞</th>
                            <th>–î–æ–ª–≥–æ—Ç–∞</th>
                            <th>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</th>
                            <th>–ì–ª—É–±–∏–Ω–∞ –¥–Ω–∞ (–º)</th>
                            <th>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å (–º)</th>
                            <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–±</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for station in stations %}
                        <tr>
                            <td>{{ station.station_name }}</td>
                            <td>{{ station.latitude|floatformat:4 }}</td>
                            <td>{{ station.longitude|floatformat:4 }}</td>
                            <td>{{ station.datetime|date:"d.m.Y H:i" }}</td>
                            <td>
                                {% if station.bottom_depth %}
                                    {{ station.bottom_depth|floatformat:1 }}
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if station.secchi_depth %}
                                    {{ station.secchi_depth|floatformat:1 }}
                                {% else %}
                                    <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-info">{{ station.samples.count }}</span>
                            </td>
                            <td>
                                <a href="{% url 'oceanography:coming_soon' %}" 
                                   class="btn btn-sm btn-outline-secondary">
                                    –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–±
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-4">
                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å—Ç–∞–Ω—Ü–∏—è—Ö –¥–ª—è —ç—Ç–æ–π —ç–∫—Å–ø–µ–¥–∏—Ü–∏–∏</p>
                <div class="btn-group mt-3">
                    <a href="{% url 'oceanography:add_station_single' expedition.pk %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω—É —Å—Ç–∞–Ω—Ü–∏—é
                    </a>
                    <a href="{% url 'oceanography:add_stations_excel' expedition.pk %}" class="btn btn-outline-primary">
                        <i class="fas fa-layer-group"></i> –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞–Ω—Ü–∏–∏
    {% if stations %}
        // –î–∞–Ω–Ω—ã–µ —Å—Ç–∞–Ω—Ü–∏–π –∏–∑ –º–æ–¥–µ–ª–∏
        const stations = [
            {% for station in stations %}
                {
                    id: {{ station.station_id }},
                    name: "{{ station.station_name|escapejs }}",
                    lat: {{ station.latitude|stringformat:"f" }},
                    lng: {{ station.longitude|stringformat:"f" }},
                    datetime: "{{ station.datetime|date:'d.m.Y H:i' }}",
                    bottom_depth: {% if station.bottom_depth %}{{ station.bottom_depth|stringformat:"f" }}{% else %}null{% endif %},
                    secchi_depth: {% if station.secchi_depth %}{{ station.secchi_depth|stringformat:"f" }}{% else %}null{% endif %},
                    samples_count: {{ station.samples.count }},
                    has_ctd: {{ station.ctd_profiles.exists|yesno:"true,false" }},
                    has_samples: {{ station.samples.exists|yesno:"true,false" }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('expedition-map');

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // –°–æ–∑–¥–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä–Ω—É—é –≥—Ä—É–ø–ø—É –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
        const markersCluster = L.markerClusterGroup({
            chunkedLoading: true,
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: true,
            zoomToBoundsOnClick: true
        });

        // –ú–∞—Å—Å–∏–≤—ã –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤ –∏ –ø–æ–¥–ø–∏—Å–µ–π
        const stationMarkers = [];
        const stationLabels = [];

        // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –º–∞—Ä–∫–µ—Ä–∞
        function getMarkerColor(station) {
            if (station.has_ctd) return '#f4a261';  // –æ—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–π —Å CTD
            if (station.has_samples) return '#e76f51';  // –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è —Å—Ç–∞–Ω—Ü–∏–π —Å –ø—Ä–æ–±–∞–º–∏
            return '#2a9d8f';  // –∑–µ–ª–µ–Ω—ã–π –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞ –º–∞—Ä–∫–µ—Ä–∞
        function getMarkerClass(station) {
            if (station.has_ctd) return 'with-ctd';
            if (station.has_samples) return 'with-samples';
            return '';
        }

        // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –∏ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Ç–∞–Ω—Ü–∏–π
        stations.forEach(station => {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏ –∫–ª–∞—Å—Å –º–∞—Ä–∫–µ—Ä–∞
            const markerColor = getMarkerColor(station);
            const markerClass = getMarkerClass(station);

            // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –º–∞—Ä–∫–µ—Ä–∞
            const markerHtml = `<div class="custom-marker ${markerClass}" style="background-color: ${markerColor};"></div>`;

            const icon = L.divIcon({
                html: markerHtml,
                className: 'custom-marker-div',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–æ–ø–∞–ø–∞
            let popupContent = `
                <div style="min-width: 200px;">
                    <h6 style="margin: 0 0 10px 0; font-weight: 600; color: #2a9d8f;">${station.name}</h6>
                    <div style="font-size: 0.9em; color: #555;">
                        <strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong> ${station.lat.toFixed(4)}, ${station.lng.toFixed(4)}<br>
                        <strong>–í—Ä–µ–º—è:</strong> ${station.datetime}<br>
            `;

            if (station.bottom_depth) {
                popupContent += `<strong>–ì–ª—É–±–∏–Ω–∞ –¥–Ω–∞:</strong> ${station.bottom_depth} –º<br>`;
            }

            if (station.secchi_depth) {
                popupContent += `<strong>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:</strong> ${station.secchi_depth} –º<br>`;
            }

            popupContent += `<strong>–ü—Ä–æ–±:</strong> ${station.samples_count}`;

            if (station.has_ctd) {
                popupContent += `<br><strong>CTD –ø—Ä–æ—Ñ–∏–ª–∏:</strong> –µ—Å—Ç—å`;
            }

            popupContent += `</div></div>`;

            // –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞
            const marker = L.marker([station.lat, station.lng], {icon: icon})
                .bindPopup(popupContent, {
                    maxWidth: 250
                });

            // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∏ —Å—Ç–∞–Ω—Ü–∏–∏
            const labelHtml = `<span class="station-label">${station.name}</span>`;

            const labelIcon = L.divIcon({
                html: labelHtml,
                className: 'station-label-div',
                iconSize: [100, 25],
                iconAnchor: [50, 25]
            });

            const label = L.marker([station.lat - 0.003, station.lng], {
                icon: labelIcon,
                zIndexOffset: -100,
                interactive: false
            });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä—ã
            stationMarkers.push(marker);
            stationLabels.push(label);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä–Ω—É—é –≥—Ä—É–ø–ø—É
        stationMarkers.forEach(marker => {
            markersCluster.addLayer(marker);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä–Ω—É—é –≥—Ä—É–ø–ø—É –Ω–∞ –∫–∞—Ä—Ç—É
        map.addLayer(markersCluster);

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∏ —Å—Ç–∞–Ω—Ü–∏–π –Ω–∞ –∫–∞—Ä—Ç—É
        stationLabels.forEach(label => {
            map.addLayer(label);
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–∏—Ä–∞–µ–º –º–∞—Å—à—Ç–∞–± —á—Ç–æ–±—ã –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –±—ã–ª–∏ –≤–∏–¥–Ω—ã
        if (stations.length > 0) {
            const group = new L.featureGroup(stationMarkers);
            map.fitBounds(group.getBounds(), {
                padding: [20, 20],
                maxZoom: 12
            });
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'info legend bg-white p-3 rounded shadow-sm');
            div.innerHTML = `
                <strong>–õ–µ–≥–µ–Ω–¥–∞:</strong><br>
                <div class="d-flex align-items-center my-1">
                    <div class="custom-marker me-2" style="background-color: #2a9d8f;"></div>
                    <small>–°—Ç–∞–Ω—Ü–∏—è</small>
                </div>
                <div class="d-flex align-items-center my-1">
                    <div class="custom-marker with-samples me-2" style="background-color: #e76f51;"></div>
                    <small>–° –ø—Ä–æ–±–∞–º–∏</small>
                </div>
                <div class="d-flex align-items-center my-1">
                    <div class="custom-marker with-ctd me-2" style="background-color: #f4a261;"></div>
                    <small>–° CTD</small>
                </div>
            `;
            return div;
        };
        legend.addTo(map);

    {% endif %}
});
</script>
{% endblock %}