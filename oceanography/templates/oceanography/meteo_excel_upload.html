{% extends 'base.html' %}
{% load humanize %}

{% block title %}Добавление метеоданных - {{ expedition.platform }} - Система наблюдений{% endblock %}

{% block content %}
    {% include 'include/_breadcrumbs.html' %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Добавление метеоданных</h1>
        <span class="badge bg-primary fs-6">{{ expedition.platform }} ({{ expedition.start_date }} - {{ expedition.end_date }})</span>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-upload me-2"></i>
                        Загрузка метеоданных
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="excel_file" class="form-label">Excel файл с метеоданными</label>
                            <input class="form-control" type="file" name="excel_file" id="excel_file" accept=".xlsx,.xls" required>
                            <div class="form-text">
                                Загрузите файл в формате Excel, соответствующий шаблону.
                            </div>
                        </div>
                        <button type="submit" name="action" value="upload_data" class="btn btn-primary" {% if not samples_without_meteo %}disabled{% endif %}>
                            <i class="fas fa-upload me-1"></i> Загрузить данные
                        </button>
                    </form>
                </div>
            </div>

            <!-- Список проб без метеоданных -->
            {% if samples_without_meteo %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-vial me-2"></i>
                        Пробы без метеоданных
                        <span class="badge bg-secondary ms-2">{{ samples_count }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>ID пробы</th>
                                    <th>Станция</th>
                                    <th>Дата и время</th>
                                    <th>Глубина отбора</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sample in samples_without_meteo %}
                                <tr>
                                    <td><code>{{ sample.sample_id }}</code></td>
                                    <td>{{ sample.station.station_name }}</td>
                                    <td>{{ sample.datetime|date:"d.m.Y H:i" }}</td>
                                    <td>{{ sample.sampling_depth }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card mt-4">
                <div class="card-body text-center text-muted py-4">
                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                    <p class="h5">Все пробы имеют метеоданные!</p>
                    <p class="mb-0">Нет проб для добавления метеоданных.</p>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Инструкция по импорту
                    </h5>
                </div>
                <div class="card-body">
                    <h6>Особенности шаблона:</h6>
                    <ul class="small">
                        <li><strong>Две строки заголовков</strong> - машинные имена и человекочитаемые названия</li>
                        <li><strong>Автозаполненные данные</strong> о пробах (не изменяйте!)</li>
                        <li><strong>Лист "Инструкция"</strong> с подробным описанием полей</li>
                        <li>Заполняйте только колонки с метеоданными (E-I)</li>
                    </ul>
                    
                    <div class="alert alert-warning small">
                        <strong>Внимание:</strong> Не изменяйте колонки A-D (ID пробы, станция, дата, горизонт) - 
                        они используются для идентификации проб.
                    </div>
                    
                    <form method="post">
                        {% csrf_token %}
                        <button type="submit" name="action" value="download_template" class="btn btn-success w-100" {% if not samples_without_meteo %}disabled{% endif %}>
                            <i class="fas fa-download me-1"></i> Скачать шаблон Excel
                        </button>
                    </form>
                </div>
            </div>

            <!-- Формат файла -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>
                        Формат файла
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Поле</th>
                                    <th>Описание</th>
                                    <th>Обязательное</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>sample_id</code></td>
                                    <td>ID пробы (не изменять)</td>
                                    <td>Да</td>
                                </tr>
                                <tr>
                                    <td><code>t_air_c</code></td>
                                    <td>Температура воздуха (°C)</td>
                                    <td>Нет</td>
                                </tr>
                                <tr>
                                    <td><code>humidity_percent</code></td>
                                    <td>Влажность (%)</td>
                                    <td>Нет</td>
                                </tr>
                                <tr>
                                    <td><code>wind_speed_m_s</code></td>
                                    <td>Скорость ветра (м/с)</td>
                                    <td>Нет</td>
                                </tr>
                                <tr>
                                    <td><code>wind_direction</code></td>
                                    <td>Направление ветра</td>
                                    <td>Нет</td>
                                </tr>
                                <tr>
                                    <td><code>pressure_hpa</code></td>
                                    <td>Давление (гПа)</td>
                                    <td>Нет</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a href="{% url 'oceanography:expedition_detail' expedition.pk %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Вернуться к экспедиции
        </a>
    </div>
{% endblock %}